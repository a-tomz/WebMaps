<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mississauga Transit & Infrastructure Analytics</title>
    <script src="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.js"></script>
    <link href="https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css" rel="stylesheet" />
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    
    <style>
        body { margin: 0; padding: 0; font-family: sans-serif; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; transition: background-color 0.3s; }
        
        /* UI Elements */
        .map-title { position: absolute; top: 15px; left: 15px; z-index: 10; background: rgba(255, 255, 255, 0.9); padding: 12px 20px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); border-left: 5px solid #0062d2; }
        .map-title h2 { margin: 0; font-size: 18px; color: #333; }
        .map-title p { margin: 5px 0 0 0; font-size: 11px; color: #666; text-transform: uppercase; letter-spacing: 1px; }

        .ui-container { position: absolute; top: 15px; right: 15px; z-index: 10; display: flex; flex-direction: column; gap: 10px; align-items: flex-end; }
        .legend { background: white; padding: 15px; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); width: 240px; max-height: 80vh; overflow-y: auto; }
        
        .toggle-btn { background: white; padding: 10px 15px; border: 2px solid #0062d2; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-bottom: 5px; }
        .analysis-btn { width: 100%; padding: 8px; margin-top: 5px; border: 1px solid #0062d2; border-radius: 4px; background: #f0f7ff; color: #0062d2; font-weight: bold; cursor: pointer; font-size: 10px; }
        .analysis-btn:hover { background: #0062d2; color: white; }
        .active-tool { background: #0062d2 !important; color: white !important; }
        .clear-btn { border-color: #d32f2f; color: #d32f2f; background: #fff5f5; }

        /* Measurement Label */
        .distance-container { position: absolute; bottom: 40px; left: 15px; z-index: 10; background: rgba(0,0,0,0.7); color: white; padding: 5px 10px; border-radius: 4px; font-size: 12px; display: none; }

        .legend-section-title { font-size: 10px; font-weight: bold; color: #888; text-transform: uppercase; margin: 10px 0 8px 0; border-bottom: 1px solid #eee; }
        .legend-item { display: flex; align-items: center; margin-bottom: 6px; font-size: 11px; }
        .legend-key { width: 20px; height: 3px; margin-right: 10px; }
    </style>
</head>
<body>

<div class="map-title">
    <h2>Mississauga Analytics</h2>
    <p>Transit Density & Measurements</p>
</div>

<div class="distance-container" id="distance-label">Distance: 0 km</div>

<div class="ui-container">
    <button id="basemap-toggle" class="toggle-btn">BASEMAP: STREETS</button>
    
    <div class="legend">
        <div class="legend-section-title">Visuals</div>
        <div class="legend-item"><input type="checkbox" id="check-heatmap"> Transit Heatmap</div>
        <div class="legend-item"><input type="checkbox" id="check-stops" checked> Stop Locations</div>

        <div class="legend-section-title">Analysis Tools</div>
        <button id="btn-measure" class="analysis-btn">MEASURE DISTANCE</button>
        <button id="btn-coverage" class="analysis-btn">400M SERVICE AREA</button>
        <button id="btn-clear" class="analysis-btn clear-btn">CLEAR ALL ANALYSIS</button>

        <div class="legend-section-title">Infrastructure</div>
        <div class="legend-item"><input type="checkbox" id="check-roads" checked> Road Hierarchy</div>
    </div>
</div>

<div id="map"></div>

<script>
    /* DATA PLACEHOLDERS - Paste your full JSON content here */
    const stopsData = { "type": "FeatureCollection", "features": [] }; 
    const roadsData = { "type": "FeatureCollection", "features": [] };
    const boundaryData = { "type": "FeatureCollection", "features": [] };

    const map = new maplibregl.Map({
        container: 'map',
        style: {
            "version": 8,
            "sources": { "osm": { "type": "raster", "tiles": ["https://tile.openstreetmap.org/{z}/{x}/{y}.png"], "tileSize": 256 } },
            "layers": [{ "id": "osm-layer", "type": "raster", "source": "osm" }]
        },
        center: [-79.644, 43.595],
        zoom: 11
    });

    map.addControl(new maplibregl.ScaleControl(), 'bottom-left');

    let measureMode = false;
    let measurePoints = [];

    map.on('load', () => {
        map.addSource('stops', { type: 'geojson', data: stopsData });
        map.addSource('roads', { type: 'geojson', data: roadsData });

        // --- HEATMAP LAYER ---
        map.addLayer({
            id: 'stops-heat',
            type: 'heatmap',
            source: 'stops',
            layout: { 'visibility': 'none' },
            paint: {
                'heatmap-weight': 1,
                'heatmap-intensity': ['interpolate', ['linear'], ['zoom'], 0, 1, 15, 3],
                'heatmap-color': ['interpolate', ['linear'], ['heatmap-density'], 0, 'rgba(0,0,255,0)', 0.2, 'blue', 0.4, 'cyan', 0.6, 'lime', 0.8, 'yellow', 1, 'red'],
                'heatmap-radius': ['interpolate', ['linear'], ['zoom'], 0, 2, 15, 20],
                'heatmap-opacity': 0.7
            }
        });

        // --- STOPS LAYER ---
        map.addLayer({
            id: 'stops-point',
            type: 'circle',
            source: 'stops',
            paint: { 'circle-color': '#f1c40f', 'circle-radius': 4, 'circle-stroke-width': 1 }
        });

        // --- ROADS LAYER ---
        map.addLayer({
            id: 'roads-line',
            type: 'line',
            source: 'roads',
            paint: { 'line-color': '#ff5722', 'line-width': 1.5, 'line-opacity': 0.6 }
        });

        // --- DISTANCE MEASURER LOGIC ---
        map.on('click', (e) => {
            if (!measureMode) return;

            const point = [e.lngLat.lng, e.lngLat.lat];
            measurePoints.push(point);

            if (measurePoints.length > 1) {
                const line = turf.lineString(measurePoints);
                const length = turf.length(line, {units: 'kilometers'}).toFixed(2);
                document.getElementById('distance-label').innerText = `Distance: ${length} km`;
                document.getElementById('distance-label').style.display = 'block';

                if (map.getSource('measure-source')) {
                    map.getSource('measure-source').setData(line);
                } else {
                    map.addSource('measure-source', { type: 'geojson', data: line });
                    map.addLayer({ id: 'measure-layer', type: 'line', source: 'measure-source', paint: { 'line-color': '#0062d2', 'line-width': 3, 'line-dasharray': [1, 1] } });
                }
            }
        });

        // --- UI ACTIONS ---
        document.getElementById('btn-measure').addEventListener('click', function() {
            measureMode = !measureMode;
            measurePoints = [];
            this.classList.toggle('active-tool');
            if (!measureMode) document.getElementById('distance-label').style.display = 'none';
        });

        document.getElementById('check-heatmap').addEventListener('change', (e) => {
            map.setLayoutProperty('stops-heat', 'visibility', e.target.checked ? 'visible' : 'none');
        });

        document.getElementById('btn-coverage').addEventListener('click', () => {
            const buffered = turf.buffer(stopsData, 0.4, {units: 'kilometers'});
            if (map.getSource('buffer')) map.getSource('buffer').setData(buffered);
            else {
                map.addSource('buffer', { type: 'geojson', data: buffered });
                map.addLayer({ id: 'buffer-layer', type: 'fill', source: 'buffer', paint: { 'fill-color': '#0062d2', 'fill-opacity': 0.2 } });
            }
        });

        document.getElementById('btn-clear').addEventListener('click', () => {
            if (map.getLayer('buffer-layer')) map.removeLayer('buffer-layer');
            if (map.getSource('buffer')) map.removeSource('buffer');
            if (map.getLayer('measure-layer')) map.removeLayer('measure-layer');
            if (map.getSource('measure-source')) map.removeSource('measure-source');
            measurePoints = [];
            document.getElementById('distance-label').style.display = 'none';
        });
    });
</script>
</body>
</html>
